<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SWDSMS | Incident Reports</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --light-blue:#C3E7F1;
  --moonstone:#519CAB;
  --saffron:#FFC64F;
  --gunmetal:#20373B;
  --white:#ffffff;
  --soft:#f4fbfd;
  --shadow:0 10px 25px rgba(0,0,0,0.08);
}

*{
  box-sizing:border-box;
  font-family:'Segoe UI', sans-serif;
}

/* Local styles for users panel */
.controls-row{ display:flex; gap:12px; align-items:center; margin-bottom:12px; }
.controls-row .search{ flex:1; }
.toggle-users-btn{ padding:8px 12px; border-radius:8px; border:none; background:var(--moonstone); color:#fff; cursor:pointer; }
.users-section{ display:none; margin-bottom:18px; }
.users-title{ margin-bottom:8px; font-weight:700; color:#20373B; }
.users-table-wrap{ margin-bottom:12px; }

body{
  margin:0;
  background:var(--light-blue);
  min-height:100vh;
  display:flex;
  flex-direction:column;
}

/* ===== TOP BAR ===== */
.topbar{
  height:70px;
  background:var(--gunmetal);
  color:white;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 30px;
  box-shadow:0 2px 10px rgba(0,0,0,0.2);
  position:sticky;
  top:0;
  z-index:100;
}

.brand{
  display:flex;
  align-items:center;
  gap:12px;
  font-size:22px;
  font-weight:700;
}

.brand img{
  width:40px;
  height:40px;
  border-radius:50%;
  background:white;
  padding:4px;
}

/* Logout */
.logout-btn{
  background:var(--moonstone);
  border:none;
  color:white;
  padding:10px 22px;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
  transition:.25s ease;
}

.logout-btn:hover{
  background:#3f8896;
  transform:translateY(-1px);
}

/* ===== USER AREA ===== */
.user-area{
  display:flex;
  align-items:center;
  gap:18px;
}

.user-info{
  display:flex;
  align-items:center;
  gap:10px;
  background:rgba(255,255,255,0.12);
  padding:8px 14px;
  border-radius:20px;
  font-weight:600;
  font-size:14px;
}

.user-info img{
  width:28px;
  height:28px;
  border-radius:50%;
  background:white;
  padding:4px;
}

/* ===== LAYOUT ===== */
.layout{
  display:flex;
  flex:1;
}

/* ===== SIDEBAR ===== */
.sidebar{
  width:250px;
  background:var(--gunmetal);
  color:white;
  padding-top:25px;
  display:flex;
  flex-direction:column;
  gap:6px;
  box-shadow:2px 0 10px rgba(0,0,0,0.15);
}

.sidebar a{
  text-decoration:none;
  color:white;
  padding:14px 26px;
  font-size:15px;
  display:flex;
  align-items:center;
  transition:.25s ease;
  border-left:4px solid transparent;
}

.sidebar a:hover{
  background:rgba(255,255,255,0.08);
  border-left:4px solid var(--saffron);
}

.sidebar a.active{
  background:rgba(255,255,255,0.14);
  border-left:4px solid var(--saffron);
  font-weight:600;
}

/* ===== CONTENT ===== */
.content{
  flex:1;
  background:var(--light-blue);
  display:flex;
  justify-content:center;
  padding:40px 24px;
}

.page-container{
  width:100%;
  max-width:1100px;
}

/* ===== CARD ===== */
.container{
  background:var(--white);
  border-radius:20px;
  padding:38px;
  box-shadow:var(--shadow);
  width:100%;
}

.title{
  font-size:28px;
  font-weight:700;
  color:var(--gunmetal);
  margin-bottom:22px;
}

.search{
  width:100%;
  padding:13px 16px;
  border-radius:12px;
  border:1px solid #d6e3e7;
  margin-bottom:22px;
  font-size:14px;
}

/* ===== TABLE ===== */
.table-wrap{
  overflow-x:auto;
  border-radius:12px;
}

table{
  width:100%;
  border-collapse:collapse;
  background:white;
}

thead{
  background:var(--soft);
}

th, td{
  padding:14px 16px;
  text-align:left;
  border-bottom:1px solid #e3eef2;
  font-size:14px;
}

tbody tr:hover{
  background:#f3fbfe;
}

/* ===== RESPONSIVE ===== */
@media (max-width:900px){
  .sidebar{width:210px;}
}

@media (max-width:700px){
  .layout{flex-direction:column;}

  .sidebar{
    width:100%;
    flex-direction:row;
    justify-content:space-around;
    padding:10px 0;
  }

  .sidebar a{
    border-left:none;
    border-bottom:3px solid transparent;
    justify-content:center;
    padding:12px;
  }

  .sidebar a.active{
    border-bottom:3px solid var(--saffron);
    border-left:none;
  }
}
</style>
</head>

<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="brand">
    <img src="logo.png" alt="SWDSMS logo">
    <span>SWDSMS</span>
  </div>

  <div class="user-area">
    <div class="user-info">
      <img src="user-icon.jpg" alt="Administrator avatar">
      <span>Administrator</span>
    </div>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
</div>

<div class="layout">

<!-- SIDEBAR -->
<div class="sidebar">
  <a href="admin-dashboard.html">Dashboard</a>
  <a href="#" class="active">Incident List/Table</a>
</div>

<!-- CONTENT -->
<div class="content">
<div class="page-container">

<div class="container">
  <div class="title">Incident List/Table</div>

  <div class="controls-row">
    <input class="search" type="text" placeholder="Search by student name">
    <button id="toggleUsersBtn" class="toggle-users-btn">Show users</button>
  </div>

  <!-- USERS (from Supabase) -->
  <div id="usersSection" class="users-section">
    <div class="users-title">Registered users (from Supabase)</div>
    <div class="table-wrap users-table-wrap">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Role</th>
            <th>Status</th>
            <th>Email</th>
          </tr>
        </thead>
        <tbody id="usersBody"></tbody>
      </table>
    </div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Codename</th>
          <th>Grade</th>
          <th>Type</th>
          <th>Description</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="incidentBody"></tbody>
    </table>
  </div>
</div>

</div>
</div>

</div>

<script>
const params = new URLSearchParams(window.location.search);
const typeFilter = params.get("type");

const tableBody = document.getElementById("incidentBody");
const searchInput = document.querySelector(".search");

function renderTable(data){
  tableBody.innerHTML="";

  if(data.length===0){
    tableBody.innerHTML=`<tr><td colspan="5" style="text-align:center;color:#888;">No reports found</td></tr>`;
    return;
  }

  data.forEach(rep=>{
    const tr=document.createElement("tr");
    const name = rep.name || rep.Name || 'N/A';
    const codename = rep.codename || rep.Codename || '';
    const grade = rep.grade || rep.Grade || 'N/A';
    const type = rep.type || rep.Type || 'N/A';
    const description = rep.description || rep.Description || 'N/A';
    const date = rep.date || rep.Date || 'N/A';

    tr.innerHTML=`
      <td>${name}</td>
      <td>${codename || '-'}</td>
      <td>${grade}</td>
      <td>${type}</td>
      <td>${description}</td>
      <td>${date}</td>
    `;
    tableBody.appendChild(tr);
  });
}

async function loadReports(){
  try{
    const res = await fetch('/api/reports');
    const reports = await res.json();

    let filtered = reports;
    if(typeFilter){
      filtered = reports.filter(r=> (r.Type||'').toLowerCase().includes(typeFilter.toLowerCase()));
    }
    renderTable(filtered);

    searchInput.addEventListener('input', ()=>{
      const val = searchInput.value.toLowerCase();
      const result = reports.filter(r => JSON.stringify(r).toLowerCase().includes(val));
      renderTable(result);
    });

  }catch(err){
    console.error(err);
    tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#c00;">Failed to load reports</td></tr>`;
    showToast && showToast('Failed to load reports','error');
  }
}

async function loadUsers(){
  const usersBody = document.getElementById('usersBody');
  try{
    const res = await fetch('/api/users');
    if(!res.ok){
      if(res.status === 405) return showToast('Method Not Allowed (users)', 'error');
      throw new Error('Failed to fetch users');
    }
    const users = await res.json();
    usersBody.innerHTML = '';
    if(!users || users.length === 0){
      usersBody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#888;">No users</td></tr>`;
      return;
    }

    users.forEach(u => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${u.id}</td>
        <td>${u.username||'N/A'}</td>
        <td>${u.role||'N/A'}</td>
        <td>${u.status||'N/A'}</td>
        <td>${u.email||'N/A'}</td>
      `;
      usersBody.appendChild(tr);
    });
  }catch(err){
    console.error(err);
    usersBody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#c00;">Failed to load users</td></tr>`;
    showToast && showToast('Failed to load users','error');
  }
}

loadReports();

// toggle users
const toggleBtn = document.getElementById('toggleUsersBtn');
const usersSection = document.getElementById('usersSection');
toggleBtn.addEventListener('click', async ()=>{
  if(usersSection.style.display === 'none'){
    usersSection.style.display = 'block';
    toggleBtn.textContent = 'Hide users';
    await loadUsers();
  }else{
    usersSection.style.display = 'none';
    toggleBtn.textContent = 'Show users';
  }
});

function logout(){
  window.location.href="index.html";
}
</script>

</body>
</html>
